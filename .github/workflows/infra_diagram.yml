name: Diagrama de Infraestructura

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate-diagram:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Install Graphviz
        run: sudo apt-get install -y graphviz
      
      - name: Install terraform-docs
        run: |
          curl -Lo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/
      
      - name: Generate Terraform Graph
        working-directory: infra
        run: |
          terraform init
          
          # Crear directamente un archivo DOT simplificado sin usar terraform graph
          echo "Creando diagrama simplificado de infraestructura..."
          cat > terraform-graph.dot << EOF
          digraph {
            rankdir = LR;
            
            // Nodos principales
            "google_compute_network" [shape=box, style=filled, fillcolor=lightblue];
            "google_compute_subnetwork" [shape=box, style=filled, fillcolor=lightblue];
            "google_container_cluster" [shape=box, style=filled, fillcolor=lightgreen];
            
            // Relaciones
            "google_compute_network" -> "google_compute_subnetwork";
            "google_compute_subnetwork" -> "google_container_cluster";
            
            // Nodos adicionales
            "kubernetes_namespace" [shape=box, style=filled, fillcolor=lightyellow];
            "kubernetes_deployment" [shape=box, style=filled, fillcolor=lightyellow];
            "kubernetes_service" [shape=box, style=filled, fillcolor=lightyellow];
            "kubernetes_ingress" [shape=box, style=filled, fillcolor=lightyellow];
            
            // Relaciones adicionales
            "google_container_cluster" -> "kubernetes_namespace";
            "kubernetes_namespace" -> "kubernetes_deployment";
            "kubernetes_deployment" -> "kubernetes_service";
            "kubernetes_service" -> "kubernetes_ingress";
            
            // Etiquetas
            label = "Diagrama de Infraestructura";
            fontsize = 20;
          }
          EOF
          
          # Generar imagen con el archivo DOT creado manualmente
          dot -Tpng terraform-graph.dot -o terraform-graph.png
      
      - name: Generate Infrastructure Documentation
        working-directory: infra
        run: |
          terraform-docs markdown . > infra-docs.md
      
      - name: Commit and Push Diagram
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          mkdir -p docs/diagrams
          cp infra/terraform-graph.png docs/diagrams/
          cp infra/infra-docs.md docs/
          git add docs/diagrams/terraform-graph.png docs/infra-docs.md
          git commit -m "Actualizar diagrama de infraestructura [skip ci]" || echo "No changes to commit"
          git push